from flask import Flask, request, jsonify
from flask_cors import CORS
from zapv2 import ZAPv2
import time

app = Flask(__name__)
CORS(app)

# Configure your ZAP proxy settings
ZAP_URL = 'http://localhost:8090'  # ZAP is running on this port
api_key = 'v9jqauo0d29sv813ajk79pc'  # Your ZAP API key
zap = ZAPv2(apikey=api_key, proxies={'http': ZAP_URL, 'https': ZAP_URL})

@app.route('/')
def index():
    return '''
    <h1>Automated Vulnerability Scanner</h1>
    <form action="/scan" method="POST">
        <label for="url">Target URL:</label>
        <input type="text" id="url" name="url" required>
        <button type="submit">Start Scan</button>
    </form>
    '''

@app.route('/scan', methods=['POST'])
def scan():
    target_url = request.form['url']
    
    try:
        # Start the spider scan
        scan_id = zap.spider.scan(target_url)
        print(f'Starting spider scan for {target_url} with scan ID: {scan_id}')

        # Poll for scan completion
        while int(zap.spider.status(scan_id)) < 100:
            print(f'Spider scan progress: {zap.spider.status(scan_id)}%')
            time.sleep(2)

        print('Spider scan completed')

        # Start the active scan
        print('Starting active scan...')
        active_scan_id = zap.ascan.scan(target_url)
        
        # Poll for active scan completion
        while int(zap.ascan.status(active_scan_id)) < 100:
            print(f'Active scan progress: {zap.ascan.status(active_scan_id)}%')
            time.sleep(2)

        print('Active scan completed')

        # Retrieve scan results
        alerts = zap.core.alerts(baseurl=target_url)
        return jsonify(alerts)

    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5001)
